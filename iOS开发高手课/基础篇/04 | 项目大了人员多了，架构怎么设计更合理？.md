# 04 | 项目大了人员多了，架构怎么设计更合理？
进行架构整治，将业务完全解耦，将通用功能下沉，每个业务都是一个独立的 Git 仓库，每个业务都能够生成一个 Pod 库，最后再集成到一起。这样经过架构整治以后，也就没再出现过先前的窘境，开发效率也得到了极大的提升。由此可见，合理的架构是多么得重要。

## 三个问题
+ 模块粒度应该如何划分？
+ 如何分层？
+ 多团队如何协作？

## 1.模块粒度应该怎么划分
**模块划分五个原则**
+ 单一功能原则：对象功能要单一，不要在一个对象里添加很多功能。
+ 开闭原则：扩展是开放的，修改是封闭的。
+ 里氏替换原则：子类对象是可以替代基类对象的。
+ 接口隔离原则：接口的用途要单一，不要在一个接口上根据不同入参实现多个功能。
+ 依赖反转原则：方法应该依赖抽象，不要依赖实例。iOS 开发就是高层业务方法依赖于协议。

**iOS 组件，应该是包含 UI 控件、相关多个小功能的合集，是一种粒度适中的模块**

## 2.如何分层
**重新梳理组件之间的逻辑关系，进行改造**
+ 底层可以是与业务无关的基础组件，比如网络和存储等；
+ 中间层一般是通用的业务组件，比如账号、埋点、支付、购物车等；
+ 最上层是迭代业务组件，更新频率最高。

## 3.多团队如何协作
总结来讲，我想说的是团队分工要灵活，不要把人员隔离固化了，否则各干各的，做的东西相互都不用。核心上，团队分工还是要围绕着具体业务进行功能模块提炼，去解决重复建设的问题，在这个基础上把提炼出的模块做精做扎实。否则，拉一帮子人臆想出来的东西，无人问津，那就是把自己架空了。

## 好的架构
组件化是解决项目大、人员多的一种很好的手段，这在任何公司或团队都是没有歧义的。组件间关系协调却没有固定的标准，协调的优劣，成为了衡量架构优劣的一个基本标准。所以在实践中，一般分为了**协议式和中间者两种架构**设计方案。

## 协议式架构设计
主要采用的是协议式编程的思路：在编译层面使用协议定义规范，实现可在不同地方，从而达到分布管理和维护组件的目的。这种方式也遵循了依赖反转原则，是一种很好的面向对象编程的实践。

但是，这个方案的缺点也很明显，主要体现在以下两个方面：
+ 由于协议式编程缺少统一调度层，导致难于集中管理，特别是项目规模变大、团队变多的情况下，架构管控就会显得越来越重要。
+ 协议式编程接口定义模式过于规范，从而使得架构的灵活性不够高。

当需要引入一个新的设计模式来开发时，我们就会发现很难融入到当前架构中，缺乏架构的统一性。虽然协议式架构有这两方面的局限性，但由于其简单易用的特点依然被很多公司采用。

## 中间者架构
它采用中间者统一管理的方式，来控制 App 的整个生命周期中组件间的调用关系。同时，iOS 对于组件接口的设计也需要保持一致性，方便中间者统一调用。

拆分的组件都会依赖于中间者，但是组间之间就不存在相互依赖的关系了。由于其他组件都会依赖于这个中间者，相互间的通信都会通过中间者统一调度，所以组件间的通信也就更容易管理了。在中间者上也能够轻松添加新的设计模式，从而使得架构更容易扩展。
[推荐设计模式CTMediator](https://github.com/casatwy/CTMediator)

更多的还是需要在功能逻辑和组件划分上做到同层级解耦，上下层依赖清晰，这样的结构才能够使得上层组件易插拔，下层组件更稳固。而中间者架构模式更容易维护这种结构，中间者的易管控和易扩展性，也使得整体架构能够长期保持稳健与活力。所以，中间者架构就是我心目中好的架构。

