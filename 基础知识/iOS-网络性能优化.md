# iOS-网络性能优化


## 网络性能优化指导原则

1. 优化DNS解析和缓存，采用CDN
2. 对传数据进行压缩，减少传输的数据
3. 使用缓存数段来减少请求的发起次数
4. 采用策略来减少请求的发起次数，例如在上个请求未着地之前，不进行新的请求。
5. 避免网络抖动，提供重发机制。


## 优化DNS解析和缓存

1. HTTPDNS 
我们在请求一个域名的时候，需要把域名解析成ip，这就是dns解析过程。我们可以通过HTTPDNS来优化dns解析过程。

2. 采用CDN
用阿里或者腾讯CDN进行网络加速，比如分区域机房，分运营商就近接入。CDN可以用来图片，视频下载加速等。也可以用oss进行文件上传


## 对传数据进行压缩，减少传输的数据

1. 接口支持压缩
由于网络库支持gzip解压，让后台对返回的数据做gzip压缩，客户端自动进行解压。

2. 采用webp图片
据google官方实验显示：无损WebP相比PNG减少26%大小；有损WebP在相同的SSIM（Structural Similarity Index，结构相似性）下相比JPEG减少25%-34%的大小；有损WebP也支持透明通道，大小通常约为对应PNG的1/3。 对于原生图片：可以通过拦截`SDWebImageManager的loadImageWithURL:options:context:progress:completed:`方法去下载webp图片。


## 使用缓存数段来减少请求的发起次数

1. 预加载
通过预加载机制来加快页面显示。比如在app启动时候先请求首页聚合接口进行预加载，这样进入首页就能直接拿到数据进行显示了。

2. 网络数据缓存
对网路数据进行缓存，先显示缓存数据，再去请求网络数据。

3. 采用json传输数据
我们一般是采用json传输数据，同等数据pb传输大小xml>json>pb.


## 采用策略来减少请求的发起次数

1. 聚合接口
在一些复杂业务中，可能进入一个页面会同时请求很多接口，这个时候可以考虑改成聚合接口。 聚合接口的优势是：只需要发一个请求，节省了并发发多个网络请求的请求头大小（一个头可能有几百乃至上千字节），并且可能能节省网络rtt时间(Round-Trip Time)。 比如首页、商详页这种业务逻辑很复杂的页面基本都是采用聚合接口。

2. 按需加载
只有需要时才加载。比如微信群里的图片，在聊天界面显示缩略图，点击后去下载大图。


## 其他

1. 优化接口性能
我们监控到网络接口性能，可以在后台做成监控系统，监控耗时，错误率多的接口，然后有针对性进行优化。

2. 不同网络环境优化
在不同的网络环境下，客户端进行不同的操作。比如非wifi下只下载小图， wifi下除了下载小图还自动下载大图



